<!DOCTYPE html><style>
#test-container {
			position: relative;
			height: 40px;
		}
		#test1 {
			width: 40px;
			height: 40px;
			background: red;
			position: absolute;
		}
			#test2 {
			width: 40px;
			height: 40px;
			background: red;
			position: absolute;
		}
		</style>
	 <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
	 <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
	 <div class="row-fluid">
	 	<div class="span4">
	 		<h1>Loading data</h1><p>
	 	I was inpired by <a href="http://mourner.github.com/worker-data-load/">Mourner's data load test</a>, which is all well and good if we want to do all the calculations in one worker, but what if we want to divide it up amongst several workers for prossessing?</p>
	 	<p>Easy you say, you'll open some more workers inside your worker, but alas chrome hasn't gotten around to to implimenting nested worker.
	 		</p>
	 	</div>
	 </div>
<div class="row-fluid">
<div id="test-container" class="span4">
		<div id="test1"></div>
	</div>
	<div id="test-container" class="span4">
		<div id="test2"></div>
	</div>
</div>
	<div class="row-fluid" id="startWell"><div class="span4 well"><button id="startit" class="btn btn-primary" >download dictionrary</button><span class="label label-warning" id="startWarn">26mb!</span></div></div>
<div class="row-fluid" style="display:none;" id="buttons">
	<div class="span4">
		<button type="button" id="regular" class="btn btn-primary">Transfer with structured clone</button>
		<div id="out1"></div>
	</div>
	<div class="span4">
		<button type="button" id="transferobj" class="btn btn-primary">Transfer with transferable objects</button>
		<div id="out2"></div>
	</div>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"> </script>
<script>
function animateSquare() {
	var test1 = document.getElementById('test1'),
	test2 = document.getElementById('test2')
		start = Date.now();

	window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                                   window.webkitRequestAnimationFrame || window.msRequestAnimationFrame || window.setTimeout;

	function step() {
		var now = Date.now(),
			progress = now - start;

		if (progress > 5000) {
			progress = 0;
			start = now;
		}

		test1.style.left = (progress / 10) + "px";
test2.style.left = (progress / 10) + "px";
		requestAnimationFrame(step);
	}

	requestAnimationFrame(step);
}


animateSquare();
</script>
<script src="https://raw.github.com/tildeio/rsvp.js/master/browser/rsvp.js"></script>
<script src="https://raw.github.com/timrwood/moment/2.0.0/moment.js"></script>
<script src="communist.js"></script>
<script>
var wFunc=function(data,callback){
	var ajax = function (url, cb) {
			var request = new XMLHttpRequest();
			request.open("GET", url);
				request.onreadystatechange = function() {
					if (request.readyState === 4 && request.status === 200) {
						cb(request.responseText);
						}
				};
			request.send();
		};
		function fromText(text){
	var len = text.length;
	var ab = new Uint16Array(len);
	var i = 0;
	while(i<len){
		ab[i]=text.charCodeAt(i);
		i++;
	}
	return ab.buffer;
}
var rb;
	if(data[0]==="s"){
		ajax(data[1],function(resp){	
			_db.text = resp;
			callback(_db.text.length);
		});
	}else if(data==="r"){
		if(_db.text){
		callback(_db.text);
		}else{
			callback("oh shit " + _db.text);
		}
	}else if(data==="t"){
		rb = fromText(_db.text);
		callback(rb,[rb]);
	}
};
var c = communist(wFunc);

var startButton = $("#startit");
startButton.on("click",function(){
startButton.addClass("disabled").html("loading...");
$("#startWarn").css("display","none");
var starting = c.data(["s",communist.makeUrl("dictionary.txt")]);
starting.then(function(a){
	var reg,trn;
	if(a>0){
		console.log(a);
		$("#startWell").css("display","none");
		$("#buttons").css("display","block");
		reg = $("#regular");
		reg.on("click",function(){
			reg.addClass("disabled").html("structured cloning...");
			var t1 = moment();
			c.data("r").then(function(a){
				var t2 = moment();
				var nt = "transfered via structured clone a string of length " + a.length + " took " + moment.duration(t2.diff(t1)).asMilliseconds() + " milliseconds, again?";
				console.log(nt);
				reg.removeClass("disabled").html(nt);
			},function(a){console.log(a)});
			
		});
		trn = $("#transferobj");
		trn.on("click",function(){
			trn.addClass("disabled").html("transfering...");
			var t1 = moment();
			c.data("t").then(function(a){
				var t2 = moment();
				var nt = "transfered ownershipt an array buffer of byteLength " + a.byteLength + " took " + moment.duration(t2.diff(t1)).asMilliseconds() + " milliseconds, again?";
				console.log(nt);
				trn.removeClass("disabled").html(nt);
			},function(a){console.log(a)});
			
		});
	}
});
});


</script>