/*! communist 2013-04-30*/
/*!©2013 Calvin Metcalf @license MIT https://github.com/calvinmetcalf/communist */
/*!Includes Promiscuous ©2013 Ruben Verborgh @license MIT https://github.com/RubenVerborgh/promiscuous*/
"undefined"==typeof document?self.onmessage=function(e){eval(e.data)}:function(){"use strict";function e(e){var n,t=e.match(/(importScripts\(.*\);)/);return n=t?t[0].replace(/importScripts\((.*)\);?/,function(e,n){return n?"importScripts("+n.split(",").map(function(e){return'"'+i.makeUrl(e.slice(1,-1))+'"'})+");\n":""})+e.replace(/(importScripts\(.*\);?)/,"\n"):e}function n(){for(var e=document.getElementsByTagName("script"),n=e.length,t=0;n>t;){if(/communist(\.min)?\.js/.test(e[t].src))return e[t].src;t++}}function t(t){var r,a=e(t.join(""));i.URL=i.URL||window.URL||window.webkitURL;try{r=new Worker(i.URL.createObjectURL(new Blob([a],{type:"text/javascript"})))}catch(u){r=new Worker(n()),r.postMessage(a)}finally{return r}}function r(e,n){var r=i.deferred(),a=t(["var _self={};\n_self.fun = ",e,";\n	_self.cb=function(data,transfer){\n			transfer?self.postMessage(data,transfer):self.postMessage(data);\n			self.close();\n		};\n		_self.result = _self.fun(",JSON.stringify(n),',_self.cb);\n		if(typeof _self.result !== "undefined"){\n			_self.cb(_self.result);\n		}']);return a.onmessage=function(e){r.resolve(e.data)},a.onerror=function(e){e.preventDefault(),r.reject(e.message)},r.promise}function a(e,n,r){var a=new Communist,u=t(["var _close=function(){self.close();};var _db={};\nvar _self={};\n_self.fun = ",e,';\n		_self.cb=function(data,transfer){\n			transfer?self.postMessage(data,transfer):self.postMessage(data);\n		};\n		self.onmessage=function(e){\n		_self.result = _self.fun(e.data,_self.cb);\n			if(typeof _self.result !== "undefined"){\n				_self.cb(_self.result);\n			}\n		}']);return u.onmessage=function(e){n(e.data)},u.onerror=r?r:function(){n()},a.data=function(e,n){return n?u.postMessage(e,n):u.postMessage(e),a},a.close=function(){return u.terminate()},a}function u(e){var n=new Communist,t=[],r=function(e){"string"!=typeof e&&e.preventDefault&&(e.preventDefault(),e=e.message),t.forEach(function(n){n&&n.reject(e)})},u="function(data,cb){_self.func = "+e+';\n		_self.boundCB = function(d,tran){\n			tran?cb([data[0],d],tran):cb([data[0],d]);\n		};\n		_self.result = _self.func(data[1],_self.boundCB);\n		if(typeof _self.result !== "undefined"){\n			_self.boundCB(_self.result);\n		}\n	}',o=function(e){t[e[0]].resolve(e[1]),t[e[0]]=0},f=a(u,o,r);return n.close=function(){f.close(),r("closed")},n.data=function(e,n){var r=t.length;return t[r]=i.deferred(),n?f.data([r,e],n):f.data([r,e]),t[r].promise},n}function o(e,n){var t=new Communist,r="function(dat,cb){ var fun = "+e+';\n		switch(dat[0]){\n			case "data":\n				if(!_db._r){\n					_db._r = dat[1];\n				}else{\n					_db._r = fun(_db._r,dat[1]);\n				}\n				break;\n			case "get":\n				return cb(_db._r);\n			case "close":\n				cb(_db._r);\n				_close();\n				break;\n		}\n	};',u=function(e){n(e)},o=a(r,u);return t.data=function(e,n){return n?o.data(["data",e],n):o.data(["data",e]),t},t.fetch=function(){return o.data(["get"]),t},t.close=function(e){e&&(n=function(){}),o.data(["close"])},t}function f(e){function n(){for(var e=0,n=s.length;n>e&&c>0&&l>0;)c--,s[e].data(d.pop()),e++,l--;return f}function t(){u.close(),s.forEach(function(e){e.close()})}var r,u,f=new Communist,c=0,s=[],d=[],l=e,p=!1,_=!1,v={map:!1,reduce:!1,data:!1},m=function(){return v.map&&v.reduce&&v.data?n():f};return f.map=function(n,r){if(v.map)return f;for(var o=0;e>o;)(function(){var o,f=a(n,function(n){void 0!==typeof n&&u.data(n),c>0?(c--,o=d.pop(),r?f.data(o,[o]):f.data(o)):(l++,l===e&&(v.data=!1,_?t():p&&(p=!1,u.fetch())))});s.push(f)})(),o++;return v.map=!0,m()},f.reduce=function(e){return v.reduce?f:(u=o(e,function(e){r&&(r.resolve(e),r=!1)}),v.reduce=!0,m())},f.data=function(e){return _?void 0:(c+=e.length,d=d.concat(e),v.data=!0,m())},f.fetch=function(n){return r||(r=i.deferred()),e>l&&!n?p=!0:u.fetch(),r.promise},f.close=function(){return r||(r=i.deferred()),e>l?_=!0:t(),r.promise},f}function c(e){function n(){return a.data&&a.map&&a.reduce?r.close():t}var t=new Communist,r=f(e),a={data:!1,map:!1,reduce:!1};return t.map=function(e,t){return a.map=!0,r.map(e,t),n()},t.reduce=function(e){return a.reduce=!0,r.reduce(e),n()},t.data=function(e){return a.data=!0,r.data(e),n()},t}function s(e){var n=new Communist,t=0,r="{",a=function(e){var n=function(){var n=Array.prototype.slice.call(arguments);return c.data([e,n])};return n};for(var o in e)0!==t?r+=",":t++,r=r+o+":"+(""+e[o]),n[o]=a(o);r+="}";var f='function(data,cb){\n		var cont;\n		if(data[0]==="__start__"){\n			_self.obj = '+r+";\n			return true;\n		}\n		else{\n		cont =data[1];\n		cont.push(cb);\n		return _self.obj[data[0]].apply(null,cont);\n		}\n	}",c=u(f);return n._close=c.close,c.data(["__start__"]),n}function i(e,n,t){return"number"!=typeof e&&"function"==typeof n?a(e,n,t):"object"!=typeof e||Array.isArray(e)?"number"!=typeof e?n?r(e,n):u(e):"number"==typeof e?n?c(e):f(e):void 0:s(e)}(function(e){function n(){var e,o,f={then:function(n,t){return e(n,t)}};return function(){var c=[];e=function(e,t){var r=n();return c.push({d:r,resolve:e,reject:t}),r.promise},o=function(n,s,i){for(var d=0,l=c.length;l>d;d++){var p=c[d],_=p.d,v=p[n];typeof v!==a?_[n](s):r(v,s,_)}e=t(f,s,i),o=u}}(),{resolve:function(e){o("resolve",e,!0)},reject:function(e){o("reject",e,!1)},promise:f}}function t(e,t,u){return function(o,f){var c,s=u?o:f;return typeof s!==a?e:(setTimeout(r.bind(e,s,t,c=n())),c.promise)}}function r(e,n,t){try{var r=e(n);r&&typeof r.then===a?r.then(t.resolve,t.reject):t.resolve(r)}catch(u){t.reject(u)}}var a="function",u=function(){};e.resolve=function(e){var n={};return n.then=t(n,e,!0),n},e.reject=function(e){var n={};return n.then=t(n,e,!1),n},e.deferred=n})(i);var Communist=function(){};i.reducer=o,i.worker=t,i.makeUrl=function(e){var n=document.createElement("link");return n.href=e,n.href},i.ajax=function(e,n,t){var r=t?"request.responseText":"JSON.parse(request.responseText)",a=n?"("+(""+n)+")("+r+",_cb)":r,u='function (url, _cb) {\n		var request = new XMLHttpRequest();\n		request.open("GET", url);\n			request.onreadystatechange = function() {\n				var _resp;\n				if (request.readyState === 4 && request.status === 200) {\n_resp = '+a+';\n					if(typeof _resp!=="undefined"){_cb(_resp);}\n					}\n			};\n		request.send();\n	}';return i(u,i.makeUrl(e))},window.communist=i}();