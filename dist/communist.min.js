/*! communist 2013-05-19*/
/*!©2013 Calvin Metcalf @license MIT https://github.com/calvinmetcalf/communist */
/*!Includes Promiscuous ©2013 Ruben Verborgh @license MIT https://github.com/RubenVerborgh/promiscuous*/
"undefined"==typeof document?(self._noTransferable=!0,self.onmessage=function(e){eval(e.data)}):function(){"use strict";function e(e){var n,t=e.match(/(importScripts\(.*\);)/);return n=t?t[0].replace(/importScripts\((.*\.js\')\);?/,function(e,n){return n?"importScripts("+n.split(",").map(function(e){return"'"+l.makeUrl(e.slice(1,-1))+"'"})+");\n":""})+e.replace(/(importScripts\(.*\.js\'\);?)/,"\n"):e}function n(){for(var e=document.getElementsByTagName("script"),n=e.length,t=0;n>t;){if(/communist(\.min)?\.js/.test(e[t].src))return e[t].src;t++}}function t(t){var r,a=e(t.join(""));l.URL=l.URL||window.URL||window.webkitURL;try{r=new Worker(l.URL.createObjectURL(new Blob([a],{type:"text/javascript"})))}catch(o){l._noTransferable=!0,r=new Worker(n()),r.postMessage(a)}finally{return r}}function r(e,n){var r=l.deferred(),a=t(["var _self={};\n_self.fun = ",e,";\n	_self.cb=function(data,transfer){\n			!self._noTransferable?self.postMessage(data,transfer):self.postMessage(data);\n			self.close();\n		};\n		_self.result = _self.fun(",JSON.stringify(n),',_self.cb);\n		if(typeof _self.result !== "undefined"){\n			_self.cb(_self.result);\n		}']);return a.onmessage=function(e){r.resolve(e.data)},a.onerror=function(e){e.preventDefault(),r.reject(e.message)},r.promise}function a(e,n,r){var a=new Communist,o=t(["\n	var _db={};\n	_db.__close__=function(){\n		self.close();\n	};\n	var _self={};\n	_db.__fun__ = ",e,';\n	_self.cb=function(data,transfer){\n		!self._noTransferable?self.postMessage(data,transfer):self.postMessage(data);\n	};\n	self.onmessage=function(e){\n		_self.result = _db.__fun__(e.data,_self.cb);\n			if(typeof _self.result !== "undefined"){\n				_self.cb(_self.result);\n		}\n	}']);return o.onmessage=function(e){n(e.data)},o.onerror=r?r:function(){n()},a.data=function(e,n){return l._noTransferable?o.postMessage(e):o.postMessage(e,n),a},a.close=function(){return o.terminate()},a}function o(e){return u({data:e})}function u(e){var n=new Communist,r=0,a=[],o=function(e){"string"!=typeof e&&e.preventDefault&&(e.preventDefault(),e=e.message),a.forEach(function(n){n&&n.reject(e)})};"initialize"in e||(e.initialize=function(){});var u="{",s=function(e){var n=function(n,t){var r=a.length;return a[r]=l.deferred(),l._noTransferable?c.postMessage([r,e,n]):c.postMessage([r,e,n],t),a[r].promise};return n};for(var f in e)0!==r?u+=",":r++,u=u+f+":"+(""+e[f]),n[f]=s(f);u+="}";var c=t(["\n	var _db="+u+';\n	self.onmessage=function(e){\n	var cb=function(data,transfer){\n		!self._noTransferable?self.postMessage([e.data[0],data],transfer):self.postMessage([e.data[0],data]);\n	};\n		var result = _db[e.data[1]](e.data[2],cb);\n			if(typeof result !== "undefined"){\n				cb(result);\n			}\n	}']);return c.onmessage=function(e){a[e.data[0]].resolve(e.data[1]),a[e.data[0]]=0},c.onerror=o,n._close=function(){return c.terminate(),o("closed"),l.resolve("done")},"close"in n||(n.close=n._close),n}function s(e,n){function t(e){var n;i?(n=c.pop(),i--,o[e][n[0]](n[1],n[2]).then(function(r){t(e),n[3].resolve(r)},function(r){t(e),n[3].reject(r)})):(s++,f.push(e))}function r(e,n,r){var a,u=l.deferred();return!i&&s?(a=f.pop(),s--,o[a][e](n,r).then(function(e){t(a),u.resolve(e)},function(e){t(a),u.reject(e)})):(i||!s)&&(i=c.push([e,n,r,u])),u.promise}var a=new Communist;a.batch={},a.batchTransfer={};for(var o=Array(n),s=0,f=[],c=[],i=0;n>s;)o[s]=u(e),f.push(s),s++;e._close=function(){};for(var d in e)a[d]=function(e){return function(n,t){return r(e,n,t)}}(d),a.batch[d]=function(e){return function(n){return l.all(n.map(function(n){return r(e,n)}))}}(d),a.batchTransfer[d]=function(e){return function(n){return l.all(n.map(function(n){return r(e,n[0],n[1])}))}}(d);return"close"in a||(a.close=a._close),a}function f(e,n){var t=new Communist,r="function(dat,cb){ var fun = "+e+';\n		switch(dat[0]){\n			case "data":\n				if(!this._r){\n					this._r = dat[1];\n				}else{\n					this._r = fun(this._r,dat[1]);\n				}\n				break;\n			case "get":\n				return cb(this._r);\n			case "close":\n				cb(this._r);\n				this.__close__();\n				break;\n		}\n	};',o=function(e){n(e)},u=a(r,o);return t.data=function(e,n){return l._noTransferable?u.data(["data",e]):u.data(["data",e],n),t},t.fetch=function(){return u.data(["get"]),t},t.close=function(e){e&&(n=function(){}),u.data(["close"])},t}function c(e){function n(){for(var e=0,n=c.length;n>e&&s>0&&d>0;)s--,c[e].data(i.pop()),e++,d--;return u}function t(){o.close(),c.forEach(function(e){e.close()})}var r,o,u=new Communist,s=0,c=[],i=[],d=e,p=!1,v=!1,_={map:!1,reduce:!1,data:!1},m=function(){return _.map&&_.reduce&&_.data?n():u};return u.map=function(n,r){if(_.map)return u;for(var f=0;e>f;)(function(){var u,f=a(n,function(n){void 0!==typeof n&&o.data(n),s>0?(s--,u=i.pop(),r?f.data(u,[u]):f.data(u)):(d++,d===e&&(_.data=!1,v?t():p&&(p=!1,o.fetch())))});c.push(f)})(),f++;return _.map=!0,m()},u.reduce=function(e){return _.reduce?u:(o=f(e,function(e){r&&(r.resolve(e),r=!1)}),_.reduce=!0,m())},u.data=function(e){return v?void 0:(s+=e.length,i=i.concat(e),_.data=!0,m())},u.fetch=function(n){return r||(r=l.deferred()),e>d&&!n?p=!0:o.fetch(),r.promise},u.close=function(){return r||(r=l.deferred()),e>d?v=!0:t(),r.promise},u}function i(e){function n(){return a.data&&a.map&&a.reduce?r.close():t}var t=new Communist,r=c(e),a={data:!1,map:!1,reduce:!1};return t.map=function(e,t){return a.map=!0,r.map(e,t),n()},t.reduce=function(e){return a.reduce=!0,r.reduce(e),n()},t.data=function(e){return a.data=!0,r.data(e),n()},t}function l(e,n,t){return"number"!=typeof e&&"function"==typeof n?a(e,n,t):"object"!=typeof e||Array.isArray(e)?"number"!=typeof e?n?r(e,n):o(e):"number"==typeof e?n?i(e):c(e):void 0:"number"==typeof n?s(e,n):u(e)}(function(e){function n(){var e,u,s={then:function(n,t){return e(n,t)}};return function(){var f=[];e=function(e,t){var r=n();return f.push({d:r,resolve:e,reject:t}),r.promise},u=function(n,c,i){for(var l=0,d=f.length;d>l;l++){var p=f[l],v=p.d,_=p[n];typeof _!==a?v[n](c):r(_,c,v)}e=t(s,c,i),u=o}}(),{resolve:function(e){u("resolve",e,!0)},reject:function(e){u("reject",e,!1)},promise:s}}function t(e,t,o){return function(u,s){var f,c=o?u:s;return typeof c!==a?e:(setTimeout(r.bind(e,c,t,f=n())),f.promise)}}function r(e,n,t){try{var r=e(n);r&&typeof r.then===a?r.then(t.resolve,t.reject):t.resolve(r)}catch(o){t.reject(o)}}var a="function",o=function(){};e.resolve=function(e){var n={};return n.then=t(n,e,!0),n},e.reject=function(e){var n={};return n.then=t(n,e,!1),n},e.deferred=n})(l),l.all=function(e){for(var n=l.deferred(),t=e.length,r=0,a=0,o=Array(t),u=function(e){return function(r){o[e]=r,a++,a===t&&n.resolve(o)}};t>r;)e[r].then(u(r),function(e){n.reject(e)}),r++;return n.promise};var Communist=function(){};l.reducer=f,l.worker=t,l.makeUrl=function(e){var n=document.createElement("link");return n.href=e,n.href},l.ajax=function(e,n,t){var r=t?"request.responseText":"JSON.parse(request.responseText)",a=n?"("+(""+n)+")("+r+",_cb)":r,o='function (url, _cb) {\n		var request = new XMLHttpRequest();\n		request.open("GET", url);\n			request.onreadystatechange = function() {\n				var _resp;\n				if (request.readyState === 4 && request.status === 200) {\n_resp = '+a+';\n					if(typeof _resp!=="undefined"){_cb(_resp);}\n					}\n			};\n			request.onerror=function(e){throw(e);}\n		request.send();\n	}';return l(o,l.makeUrl(e))},window.communist=l}();